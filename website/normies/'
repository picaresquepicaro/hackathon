from flask import (
    Blueprint, flash, g, redirect, render_template, request, url_for
)
from werkzeug.exceptions import abort
import google.generativeai as genai
import pandas as pd
import numpy as np

df = pd.read_csv('../shelter_occupancy_20000.csv')
print(df)

bp = Blueprint('shelter', __name__)

def haversine(lat1, lon1, lat2, lon2, R=6371.0):
    dLat = (lat2 - lat1) * np.pi / 180
    dLon = (lon2 - lon1) * np.pi / 180

    lat1 = (lat1) * np.pi / 180
    lat2 = (lat2) * np.pi / 180

    a = np.sin(dLat / 2) ** 2 + np.cos(lat1) * np.cos(lat2) * np.sin(dLon / 2) ** 2
    c = 2 * np.arcsin(np.sqrt(a))

    return R * c

@bp.route('/shelter', methods=('GET', 'POST'))
def shelter():
    if request.method == 'POST':
        latitude = request.form['latitude']
        longitude = request.form['longitude']

        genai.configure(api_key="AIzaSyBZg_vL6AShfmA8hL7yzw4HdqHPzQDtU5Y")
        model = genai.GenerativeModel("gemini-1.5-flash")
        response = model.generate_content("Where is this latitude {} and longitude {}".format(latitude, longitude))
        
        df['distance'] = haversine(df['latitude'], df['longitude'], latitude, longitude)

        df_sort = df.sort_values(by='distance', ascending=True)

        print(df.sort.head())
        
        shelters = []
        for _, row in df.iterrows[:3]():
            shelters.append(df_sort['shelter_name'] + df_sort['occupance'] + df_sort['status'] + df.sort['distance'])

        return render_template('shelter.html', response=response, shelters=shelters) 

    return render_template('shelter.html')
